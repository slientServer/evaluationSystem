<?php/** * 后台登录验证 * @author  <[l@easycms.cc]> */namespace Index\Controller;use Think\Controller;use Org\Util\Rbac;class LoginController extends Controller{	//空操作	public function _empty(){		$this->redirect("Index/Index/index");	}	//加载登录页面	public function login(){		$this->theme('default');		session('message', null);		$this->display("login");	}	//执行登录验证方法	public function checkLogin(){		$this->theme('default');		if(!IS_POST) _halt('页面不存在1');		$username=I('name');		$pwd=I('password','','md5');		//判断用户是否存在		$m=M('User');		$user=$m->where(array('username'=>$username))->find();			if (!$user || $user['password']!=$pwd) {			session('message', '帐号或密码错误！');			$this->display("login");			exit;		}		//判断验证码		$verify = new \Think\Verify();		if (!$verify->check(I('code'))) {			session('message', '验证码错误！');			$this->display("login");			exit;		}		//判断用户是否被锁定		if($user['islock']) {			session('message', '帐户被锁定！');			$this->display("login");			exit;		};		//获取用户登陆后需要修改的数据		$data=array(			'id'=>$user['id'],			'logintime'=>time(),			'loginip'=>get_client_ip()		);		$m->save($data);		session(C('USER_AUTH_KEY'),$user['id']);		session(C('ADMIN_AUTH_KEY_B'),$user['username']);		session(C('ADMIN_AUTH_KEY_SHOW_NAME'),$user['showname']);		session('logintime',date('Y-m-d H:i:s',$user['logintime']));		session('loginip',$user['loginip']);		//超级管理员识别		if($user['username'] == C('RBAC_SUPERADMIN')){			session(C('ADMIN_AUTH_KEY'),true);		}		//读取用户权限		import('ORG.Util.RBAC');		Rbac::saveAccessList();		if($user['username'] == C('RBAC_SUPERADMIN')){			$this->redirect('Admin/Index/index');		}else{			$this->redirect('Index/Index/index');		}	}	//执行退出操作方法	public function logout(){		$this->theme('default');		$_SESSION[C('USER_AUTH_KEY')]=null;		$_SESSION[C('ADMIN_AUTH_KEY')]=null;		//$_SESSION[C('ADMIN_AUTH_KEY')]=null;		unset($_SESSION['_ACCESS_LIST']);		session('message', null);		$this->display("login");	}	//加载验证码	public function verify(){		//import('ORG.Util.Image');		//Image::buildImageVerify();		$config =    array(		    'fontSize'    =>    30,    // 验证码字体大小		    'length'      =>    4,     // 验证码位数		    'useNoise'    =>    false, // 关闭验证码杂点		);		$Verify = new \Think\Verify($config);		$Verify->fontttf = '5.ttf';		$Verify->entry();	}}